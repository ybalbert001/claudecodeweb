version: '3.8'

services:
  claude-code-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: claude-code-ui-${USERNAME:-default}
    # Use host network to access EC2 instance metadata service for IAM Role credentials
    network_mode: host
    environment:
      # Server configuration
      - PORT=3001
      - NODE_ENV=production

      # AWS Bedrock configuration (automatically set)
      - CLAUDE_CODE_USE_BEDROCK=1
      - AWS_REGION=us-east-1

      # Set HOME for node user
      - HOME=/home/node

      # AWS Credentials (use environment variables or .env file)
      # - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      # - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

      # Optional: Session token for temporary credentials
      # - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}

      # Optional: Bedrock base URL for LLM Gateway
      # - ANTHROPIC_BEDROCK_BASE_URL=${ANTHROPIC_BEDROCK_BASE_URL}
      # - CLAUDE_CODE_SKIP_BEDROCK_AUTH=1

      # Optional: Corporate proxy
      # - HTTPS_PROXY=${HTTPS_PROXY}

      # Database configuration (per user)
      - DATABASE_PATH=/home/node/${USERNAME:-default}/auth.db

      # Workspace configuration (per user)
      - WORKSPACES_ROOT=/app/projects

      # Context window
      - CONTEXT_WINDOW=160000
      - VITE_CONTEXT_WINDOW=160000

      # User configuration
      - USERNAME=${USERNAME:-default}

    volumes:
      # Persist database per user
      - ./data/${USERNAME:-default}:/app/data/${USERNAME:-default}

      # Mount user-specific workspace from EC2 local disk to node user home
      - /home/ubuntu/cc-user/${USERNAME:-default}:/app/projects

      # Mount host workspace directories (optional)
      - /home/ubuntu:/home/ubuntu

      # Optional: Mount AWS credentials from host (updated for node user)
      # - ~/.aws:/home/node/.aws:ro

    # Run as node user (uid=1000, gid=1000) to match host ubuntu user
    user: "1000:1000"

    restart: unless-stopped
    
    # Shared memory size for Chromium/Playwright (required for PDF export)
    shm_size: '256m'

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Optional: Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

# Optional: Create named volumes
volumes:
  claude-data:
    driver: local
  claude-projects:
    driver: local
